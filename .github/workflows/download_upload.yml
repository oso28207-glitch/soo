name: Download & Upload Episodes from Eishq

on:
  workflow_dispatch:        # ÙŠØªÙŠØ­ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    inputs:
      start_episode:
        description: 'Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ù„Ù‚Ø©'
        required: true
        default: '1'
      end_episode:
        description: 'Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ù„Ù‚Ø©'
        required: true
        default: '5'
      season_num:
        description: 'Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ³Ù…'
        required: true
        default: '1'
  # schedule:
  #   - cron: '0 2 * * *'   # Ø§Ø®ØªÙŠØ§Ø±ÙŠ: ØªØ´ØºÙŠÙ„ ÙŠÙˆÙ…ÙŠ ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© 2 ØµØ¨Ø§Ø­Ø§Ù‹

jobs:
  process-episodes:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ðŸ“¦ Install system dependencies (chromium, chromedriver, ffmpeg)
        run: |
          sudo apt update
          sudo apt install -y chromium-browser chromium-chromedriver ffmpeg
          # ØªØ£ÙƒÙŠØ¯ ÙˆØ¬ÙˆØ¯ chromedriver ÙÙŠ PATH
          echo "/usr/lib/chromium-browser/" >> $GITHUB_PATH
          echo "CHROME_BIN=/usr/bin/chromium-browser" >> $GITHUB_ENV

      - name: ðŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyrogram tgcrypto yt-dlp curl_cffi selenium beautifulsoup4

      - name: ðŸ” Create config file from secrets (optional)
        # Ø¥Ø°Ø§ ÙƒÙ†Øª Ù„Ø§ ØªØ±ÙŠØ¯ Ø­ÙØ¸ series_config.json ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ù‡Ù†Ø§
        run: |
          echo '${{ secrets.SERIES_CONFIG }}' > series_config.json
        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ©
        continue-on-error: true

      - name: ðŸš€ Run the downloader script
        env:
          API_ID: ${{ secrets.API_ID }}
          API_HASH: ${{ secrets.API_HASH }}
          CHANNEL: ${{ secrets.CHANNEL }}
          STRING_SESSION: ${{ secrets.STRING_SESSION }}
        run: |
          # ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
          if [ -f series_config.json ]; then
            # ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… jq Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            sudo apt install -y jq
            jq --arg start "${{ github.event.inputs.start_episode }}" \
               --arg end "${{ github.event.inputs.end_episode }}" \
               --arg season "${{ github.event.inputs.season_num }}" \
               '.start_episode = ($start | tonumber) | .end_episode = ($end | tonumber) | .season_num = ($season | tonumber)' \
               series_config.json > tmp.json && mv tmp.json series_config.json
          fi
          python main1.py
